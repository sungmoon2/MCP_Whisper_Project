{% extends "base.html" %}

{% block title %}Whisper STT Light{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- ë©”ì¸ í—¤ë” -->
            <div class="text-center mb-5">
                <h1 class="display-4">ğŸ¤ Whisper STT Light</h1>
                <p class="lead text-muted">ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” ê°„ë‹¨í•œ ì›¹ì•±</p>
            </div>

            <!-- ì—…ë¡œë“œ í¼ -->
            <div id="uploadForm" class="card shadow">
                <div class="card-body p-4">
                    <form method="POST" action="/process" enctype="multipart/form-data" id="sttForm">
                        
                        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="mb-4">
                            <label for="file" class="form-label">
                                <strong>ğŸµ ìŒì„±/ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ</strong>
                            </label>
                            <input type="file" name="file" id="file" class="form-control" accept=".mp3,.wav,.flac,.m4a,.ogg,.wma,.aac,.3gp,.amr,.mp4,.mov,.avi,.mkv,.webm,.f4v,.mpg,.mpeg,.wmv" required>
                            <div class="form-text">
                                ì§€ì› í˜•ì‹: MP3, WAV, MP4, MOV ë“± (ìµœëŒ€ 500MB)
                            </div>
                        </div>
                        
                        <!-- Whisper ëª¨ë¸ ì„ íƒ -->
                        <div class="mb-4">
                            <label for="model" class="form-label">
                                <strong>ğŸ§  Whisper ëª¨ë¸ ì„ íƒ</strong>
                            </label>
                            <select name="model" id="model" class="form-select" required>
                                <option value="">ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                {% for model_id, model_desc in models.items() %}
                                <option value="{{ model_id }}">{{ model_desc }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <strong>ê¶Œì¥:</strong> small (ê· í˜•), large-v3-turbo (ìµœê³  í’ˆì§ˆ)
                            </div>
                        </div>
                        
                        <!-- ì¶œë ¥ í˜•ì‹ ì„ íƒ -->
                        <div class="mb-4">
                            <label class="form-label">
                                <strong>ğŸ“„ ì¶œë ¥ í˜•ì‹ ì„ íƒ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</strong>
                            </label>
                            <div class="row">
                                {% for format_id, format_desc in formats.items() %}
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" name="formats" value="{{ format_id }}" 
                                               class="form-check-input" id="{{ format_id }}">
                                        <label class="form-check-label" for="{{ format_id }}">
                                            {{ format_desc }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">
                                <strong>ê¶Œì¥:</strong> txt (ê¸°ë³¸), json (ìƒì„¸ ì •ë³´), srt (ìë§‰)
                            </div>
                        </div>
                        
                        <!-- ì²˜ë¦¬ ì‹œì‘ ë²„íŠ¼ -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                ğŸš€ STT ì²˜ë¦¬ ì‹œì‘
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ì§„ì²™ë„ ì„¹ì…˜ (ì²˜ìŒì—ëŠ” ìˆ¨ê²¨ì§) -->
            <div id="progressSection" class="card shadow mt-4" style="display: none;">
                <div class="card-body p-4">
                    <h5 class="card-title">STT ì²˜ë¦¬ ì¤‘...</h5>
                    <p class="text-muted mb-3">ì‘ì—… ID: <span id="taskId"></span></p>
                    
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    
                    <div id="statusMessage" class="alert alert-info">
                        ì²˜ë¦¬ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...
                    </div>
                    
                    <div class="text-center">
                        <small class="text-muted">
                            ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì²˜ë¦¬ê°€ ì™„ë£Œë˜ë©´ ê²°ê³¼ê°€ ì•„ë˜ì— í‘œì‹œë©ë‹ˆë‹¤.
                        </small>
                    </div>
                </div>
            </div>

            <!-- ê²°ê³¼ ì„¹ì…˜ (ì²˜ìŒì—ëŠ” ìˆ¨ê²¨ì§) -->
            <div id="resultSection" class="card shadow mt-4" style="display: none;">
                <div class="card-body p-4">
                    <h5 class="card-title text-success">âœ… STT ì²˜ë¦¬ ì™„ë£Œ!</h5>
                    
                    <div id="resultContent">
                        <!-- ì—¬ê¸°ì— ê²°ê³¼ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    </div>
                    
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-primary" onclick="resetForm()">
                            ğŸ”„ ìƒˆë¡œìš´ íŒŒì¼ ì²˜ë¦¬
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let checkInterval;
let currentTaskId = null;

document.getElementById('sttForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // ì—…ë¡œë“œ í¼ ìˆ¨ê¸°ê³  ì§„ì²™ë„ í‘œì‹œ
    document.getElementById('uploadForm').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('resultSection').style.display = 'none';
    
    // í¼ ì œì¶œ
    fetch('/process', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTaskId = data.task_id;
            document.getElementById('taskId').textContent = currentTaskId;
            
            // ì§„ì²™ë„ ì²´í¬ ì‹œì‘
            startProgressCheck();
        } else {
            alert('ì˜¤ë¥˜: ' + data.message);
            resetForm();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        resetForm();
    });
});

function checkProgress() {
    if (!currentTaskId) return;
    
    fetch(`/api/status/${currentTaskId}`)
        .then(response => response.json())
        .then(data => {
            updateProgress(data.progress, data.message);
            
            if (data.status === 'completed') {
                clearInterval(checkInterval);
                showResults(currentTaskId);
            } else if (data.status === 'error') {
                clearInterval(checkInterval);
                showError(data.message);
            } else if (data.status === 'processing') {
                // ê³„ì† ì²´í¬
            }
        })
        .catch(error => {
            console.error('Progress check error:', error);
        });
}

function updateProgress(progress, message) {
    const progressBar = document.getElementById('progressBar');
    const statusMessage = document.getElementById('statusMessage');
    
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    progressBar.textContent = progress + '%';
    statusMessage.textContent = message;
    
    // ì§„ì²™ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    if (progress >= 100) {
        progressBar.classList.add('bg-success');
    } else if (progress >= 50) {
        progressBar.classList.add('bg-info');
    } else {
        progressBar.classList.add('bg-primary');
    }
}

function showResults(taskId) {
    fetch(`/api/result/${taskId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
            
            let resultHTML = `
                <div class="mb-3">
                    <strong>ìƒì„±ëœ íŒŒì¼:</strong>
                </div>
                <div class="row">
            `;
            
            data.files.forEach(file => {
                resultHTML += `
                    <div class="col-md-6 mb-2">
                        <a href="/download/${taskId}/${file.name}" class="btn btn-outline-success btn-sm w-100">
                            ğŸ“„ ${file.name} (${file.size})
                        </a>
                    </div>
                `;
            });
            
            resultHTML += `
                </div>
                <div class="mt-3">
                    <a href="/download_all/${taskId}" class="btn btn-success">
                        ğŸ“¦ ëª¨ë“  íŒŒì¼ ZIP ë‹¤ìš´ë¡œë“œ
                    </a>
                </div>
            `;
            
            if (data.previews && data.previews.length > 0) {
                resultHTML += `
                    <div class="mt-4">
                        <strong>ğŸ“‹ ìƒì„±ëœ í˜•ì‹ë³„ ë¯¸ë¦¬ë³´ê¸°:</strong>
                        <div class="accordion mt-2" id="previewAccordion">
                `;
                
                data.previews.forEach((preview, index) => {
                    const isFirst = index === 0;
                    const formatClass = getFormatClass(preview.filename);
                    const formatStyle = getFormatStyle(preview.filename);
                    
                    resultHTML += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse${index}" 
                                        aria-expanded="${isFirst}" aria-controls="collapse${index}">
                                    ${preview.format} (${preview.full_length}ì)
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" 
                                 aria-labelledby="heading${index}" data-bs-parent="#previewAccordion">
                                <div class="accordion-body">
                                    <div class="border rounded p-3 ${formatClass}" style="${formatStyle}">
                                        <pre style="white-space: pre-wrap; margin: 0; font-size: 13px; font-family: 'Courier New', monospace;">${preview.content}</pre>
                                    </div>
                                    <small class="text-muted">íŒŒì¼ëª…: ${preview.filename}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resultHTML += `
                        </div>
                    </div>
                `;
            }

// í˜•ì‹ë³„ CSS í´ë˜ìŠ¤ ë°˜í™˜
function getFormatClass(filename) {
    if (filename.endsWith('.json')) return 'bg-dark text-light';
    if (filename.endsWith('.srt') || filename.endsWith('.vtt')) return 'bg-info bg-opacity-10';
    if (filename.endsWith('.tsv')) return 'bg-success bg-opacity-10';
    return 'bg-light'; // .txt
}

// í˜•ì‹ë³„ ìŠ¤íƒ€ì¼ ë°˜í™˜  
function getFormatStyle(filename) {
    if (filename.endsWith('.json')) return 'border-color: #6c757d;';
    if (filename.endsWith('.srt') || filename.endsWith('.vtt')) return 'border-color: #0dcaf0;';
    if (filename.endsWith('.tsv')) return 'border-color: #198754;';
    return 'border-color: #dee2e6;'; // .txt
}
            
            document.getElementById('resultContent').innerHTML = resultHTML;
        })
        .catch(error => {
            console.error('Result fetch error:', error);
            showError('ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

function showError(message) {
    document.getElementById('progressSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('resultContent').innerHTML = `
        <div class="alert alert-danger">
            âŒ ì˜¤ë¥˜: ${message}
        </div>
    `;
}

function resetForm() {
    // ëª¨ë“  ì„¹ì…˜ ë¦¬ì…‹
    document.getElementById('uploadForm').style.display = 'block';
    document.getElementById('progressSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'none';
    
    // í¼ ë¦¬ì…‹
    document.getElementById('sttForm').reset();
    
    // ì¸í„°ë²Œ ì •ë¦¬
    if (checkInterval) {
        clearInterval(checkInterval);
    }
    currentTaskId = null;
}

// ì§„ì²™ë„ ì²´í¬ ì‹œì‘
function startProgressCheck() {
    checkProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì²´í¬
    checkInterval = setInterval(checkProgress, 2000); // 2ì´ˆë§ˆë‹¤ ì²´í¬
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.addEventListener('load', function() {
    // ì´ˆê¸°í™” ì™„ë£Œ
});
</script>
{% endblock %}