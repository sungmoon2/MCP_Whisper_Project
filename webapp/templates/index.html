{% extends "base.html" %}

{% block title %}Whisper STT Light{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- 메인 헤더 -->
            <div class="text-center mb-5">
                <h1 class="display-4">🎤 Whisper STT Light</h1>
                <p class="lead text-muted">음성을 텍스트로 변환하는 간단한 웹앱</p>
            </div>

            <!-- 업로드 폼 -->
            <div id="uploadForm" class="card shadow">
                <div class="card-body p-4">
                    <form method="POST" action="/process" enctype="multipart/form-data" id="sttForm">
                        
                        <!-- 파일 업로드 -->
                        <div class="mb-4">
                            <label for="file" class="form-label">
                                <strong>🎵 음성/영상 파일 업로드</strong>
                            </label>
                            <input type="file" name="file" id="file" class="form-control" accept=".mp3,.wav,.flac,.m4a,.ogg,.wma,.aac,.3gp,.amr,.mp4,.mov,.avi,.mkv,.webm,.f4v,.mpg,.mpeg,.wmv" required>
                            <div class="form-text">
                                지원 형식: MP3, WAV, MP4, MOV 등 (최대 500MB)
                            </div>
                        </div>
                        
                        <!-- Whisper 모델 선택 -->
                        <div class="mb-4">
                            <label for="model" class="form-label">
                                <strong>🧠 Whisper 모델 선택</strong>
                            </label>
                            <select name="model" id="model" class="form-select" required>
                                <option value="">모델을 선택하세요</option>
                                {% for model_id, model_desc in models.items() %}
                                <option value="{{ model_id }}">{{ model_desc }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <strong>권장:</strong> small (균형), large-v3-turbo (최고 품질)
                            </div>
                        </div>
                        
                        <!-- 출력 형식 선택 -->
                        <div class="mb-4">
                            <label class="form-label">
                                <strong>📄 출력 형식 선택 (복수 선택 가능)</strong>
                            </label>
                            <div class="row">
                                {% for format_id, format_desc in formats.items() %}
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" name="formats" value="{{ format_id }}" 
                                               class="form-check-input" id="{{ format_id }}">
                                        <label class="form-check-label" for="{{ format_id }}">
                                            {{ format_desc }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">
                                <strong>권장:</strong> txt (기본), json (상세 정보), srt (자막)
                            </div>
                        </div>
                        
                        <!-- 처리 시작 버튼 -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                🚀 STT 처리 시작
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 진척도 섹션 (처음에는 숨겨짐) -->
            <div id="progressSection" class="card shadow mt-4" style="display: none;">
                <div class="card-body p-4">
                    <h5 class="card-title">STT 처리 중...</h5>
                    <p class="text-muted mb-3">작업 ID: <span id="taskId"></span></p>
                    
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    
                    <div id="statusMessage" class="alert alert-info">
                        처리 상태를 확인하는 중...
                    </div>
                    
                    <div class="text-center">
                        <small class="text-muted">
                            잠시만 기다려주세요. 처리가 완료되면 결과가 아래에 표시됩니다.
                        </small>
                    </div>
                </div>
            </div>

            <!-- 결과 섹션 (처음에는 숨겨짐) -->
            <div id="resultSection" class="card shadow mt-4" style="display: none;">
                <div class="card-body p-4">
                    <h5 class="card-title text-success">✅ STT 처리 완료!</h5>
                    
                    <div id="resultContent">
                        <!-- 여기에 결과가 동적으로 추가됨 -->
                    </div>
                    
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-primary" onclick="resetForm()">
                            🔄 새로운 파일 처리
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let checkInterval;
let currentTaskId = null;

document.getElementById('sttForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // 업로드 폼 숨기고 진척도 표시
    document.getElementById('uploadForm').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('resultSection').style.display = 'none';
    
    // 폼 제출
    fetch('/process', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTaskId = data.task_id;
            document.getElementById('taskId').textContent = currentTaskId;
            
            // 진척도 체크 시작
            startProgressCheck();
        } else {
            alert('오류: ' + data.message);
            resetForm();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('처리 중 오류가 발생했습니다.');
        resetForm();
    });
});

function checkProgress() {
    if (!currentTaskId) return;
    
    fetch(`/api/status/${currentTaskId}`)
        .then(response => response.json())
        .then(data => {
            updateProgress(data.progress, data.message);
            
            if (data.status === 'completed') {
                clearInterval(checkInterval);
                showResults(currentTaskId);
            } else if (data.status === 'error') {
                clearInterval(checkInterval);
                showError(data.message);
            } else if (data.status === 'processing') {
                // 계속 체크
            }
        })
        .catch(error => {
            console.error('Progress check error:', error);
        });
}

function updateProgress(progress, message) {
    const progressBar = document.getElementById('progressBar');
    const statusMessage = document.getElementById('statusMessage');
    
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    progressBar.textContent = progress + '%';
    statusMessage.textContent = message;
    
    // 진척도에 따른 색상 변경
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    if (progress >= 100) {
        progressBar.classList.add('bg-success');
    } else if (progress >= 50) {
        progressBar.classList.add('bg-info');
    } else {
        progressBar.classList.add('bg-primary');
    }
}

function showResults(taskId) {
    fetch(`/api/result/${taskId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
            
            let resultHTML = `
                <div class="mb-3">
                    <strong>생성된 파일:</strong>
                </div>
                <div class="row">
            `;
            
            data.files.forEach(file => {
                resultHTML += `
                    <div class="col-md-6 mb-2">
                        <a href="/download/${taskId}/${file.name}" class="btn btn-outline-success btn-sm w-100">
                            📄 ${file.name} (${file.size})
                        </a>
                    </div>
                `;
            });
            
            resultHTML += `
                </div>
                <div class="mt-3">
                    <a href="/download_all/${taskId}" class="btn btn-success">
                        📦 모든 파일 ZIP 다운로드
                    </a>
                </div>
            `;
            
            if (data.previews && data.previews.length > 0) {
                resultHTML += `
                    <div class="mt-4">
                        <strong>📋 생성된 형식별 미리보기:</strong>
                        <div class="accordion mt-2" id="previewAccordion">
                `;
                
                data.previews.forEach((preview, index) => {
                    const isFirst = index === 0;
                    const formatClass = getFormatClass(preview.filename);
                    const formatStyle = getFormatStyle(preview.filename);
                    
                    resultHTML += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse${index}" 
                                        aria-expanded="${isFirst}" aria-controls="collapse${index}">
                                    ${preview.format} (${preview.full_length}자)
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" 
                                 aria-labelledby="heading${index}" data-bs-parent="#previewAccordion">
                                <div class="accordion-body">
                                    <div class="border rounded p-3 ${formatClass}" style="${formatStyle}">
                                        <pre style="white-space: pre-wrap; margin: 0; font-size: 13px; font-family: 'Courier New', monospace;">${preview.content}</pre>
                                    </div>
                                    <small class="text-muted">파일명: ${preview.filename}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resultHTML += `
                        </div>
                    </div>
                `;
            }

// 형식별 CSS 클래스 반환
function getFormatClass(filename) {
    if (filename.endsWith('.json')) return 'bg-dark text-light';
    if (filename.endsWith('.srt') || filename.endsWith('.vtt')) return 'bg-info bg-opacity-10';
    if (filename.endsWith('.tsv')) return 'bg-success bg-opacity-10';
    return 'bg-light'; // .txt
}

// 형식별 스타일 반환  
function getFormatStyle(filename) {
    if (filename.endsWith('.json')) return 'border-color: #6c757d;';
    if (filename.endsWith('.srt') || filename.endsWith('.vtt')) return 'border-color: #0dcaf0;';
    if (filename.endsWith('.tsv')) return 'border-color: #198754;';
    return 'border-color: #dee2e6;'; // .txt
}
            
            document.getElementById('resultContent').innerHTML = resultHTML;
        })
        .catch(error => {
            console.error('Result fetch error:', error);
            showError('결과를 가져오는 중 오류가 발생했습니다.');
        });
}

function showError(message) {
    document.getElementById('progressSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('resultContent').innerHTML = `
        <div class="alert alert-danger">
            ❌ 오류: ${message}
        </div>
    `;
}

function resetForm() {
    // 모든 섹션 리셋
    document.getElementById('uploadForm').style.display = 'block';
    document.getElementById('progressSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'none';
    
    // 폼 리셋
    document.getElementById('sttForm').reset();
    
    // 인터벌 정리
    if (checkInterval) {
        clearInterval(checkInterval);
    }
    currentTaskId = null;
}

// 진척도 체크 시작
function startProgressCheck() {
    checkProgress(); // 즉시 한 번 체크
    checkInterval = setInterval(checkProgress, 2000); // 2초마다 체크
}

// 페이지 로드 시 실행
window.addEventListener('load', function() {
    // 초기화 완료
});
</script>
{% endblock %}